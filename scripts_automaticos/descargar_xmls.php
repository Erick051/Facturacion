<?php

// datos para conexion con BD
$servername = "10.20.50.9";
$dnusr      = "apps";
$dbpss      = "apps";
$database   = "asa";


define("COD_ENVIADO_CORRECTAMENTE", "0");
define("COD_ERROR_EN_ENVIO", "200");
define("DES_ENVIADO_CORRECTAMENTE", "Mensaje enviado correctamente");
define("NUM_MAX_INTENTOS_ENVIO"   , "10");
define("ESTATUS_PENDIENTE_ENVIAR" , "1");
define("ESTATUS_ENVIADO" , "2");
define("ESTATUS_IMPOSIBLE_ENVIAR" , "3");

echo "\n------------------------------------------------------------------------------------------";
echo "\n                    Extraccion de XMLs";

// Create connection
$conexion = @mysql_connect($servername,$dnusr,$dbpss);

if ( !$conexion ) {
	echo "\nNo se pudo conectar a MySQL";
} else {
	echo "\nConexion correcta";
	if ( !@mysql_select_db($database, $conexion) ) {
		echo "\nNo se pudo elegir la BD";
	}
	else {
		// fecha y hora del dia
        $fecha = date("d/m/Y");
		$fecha_consulta = date("Y-m-d");
        $hora = date("H:i:s");
		
		echo "\nFecha: ".$fecha;
        echo "\nHora: ".$hora;
		
        // consulta de los correos que tiene que enviar
        $query  = "select * from jos_stamped where customer_trx_id in (3169665, 3170093, 3170101, 3170122, 3170202, 3170305, 3170317, 3170320, 3170328, 3170361, 3170377, 3170385, 3170496, 3170502, 3170542, 3170551, 3170588, 3170668, 3170671, 3170673, 3170684, 3170713, 3170744, 3170755, 3170759, 3170782, 3170787, 3170815, 3170824, 3170844, 3170846, 3170878, 3170900, 3170976, 3171014, 3171022, 3171067, 3171070, 3171081, 3171086, 3171106, 3171114, 3171115, 3171147, 3171153, 3171161, 3171168, 3171222, 3171225, 3171288, 3171311, 3171312, 3171328, 3171366, 3171370, 3171374, 3171497, 3171598, 3171737, 3171744, 3171750, 3171775, 3171814, 3171842, 3171924, 3171965, 3172066, 3172069, 3172183, 3172184, 3172253, 3172255, 3172280, 3172290, 3172299, 3172360, 3172389, 3172525, 3172595, 3172642, 3172668, 3172723, 3172724, 3172746, 3172751, 3172755, 3172756, 3172762, 3172775, 3172777, 3172801, 3172868, 3172968, 3172987, 3173015, 3173184, 3173207, 3173250, 3173439, 3173556, 3173565, 3173596, 3173660, 3173926, 3173966, 3174120, 3174154, 3174235, 3174286, 3174290, 3174293, 3174322, 3174850, 3174882, 3174912, 3174948, 3174959, 3174990, 3174995, 3175043, 3175095, 3175129, 3175159, 3175181, 3175191, 3175197, 3175228, 3175315, 3175321, 3175324, 3175338, 3175375, 3175414, 3175415, 3175422, 3175435, 3175462, 3175474, 3175493, 3175553, 3175568, 3175569, 3175684, 3175709, 3175710, 3175744, 3175747, 3175829, 3175834, 3175891, 3175892, 3176017, 3176095, 3176108, 3176164, 3176167, 3176196, 3176197, 3176262, 3176290, 3176322, 3176330, 3176339, 3176397, 3176481, 3176484, 3176499, 3176503, 3176643, 3176723, 3176788, 3176810, 3176845, 3176882, 3176892, 3176900, 3176951, 3176987, 3177009, 3177159, 3177259, 3177351, 3177365, 3177386, 3177638, 3177649, 3177736, 3177760, 3177780, 3177785, 3177795, 3177796, 3177798, 3177828, 3177849, 3177861, 3177944, 3177963, 3178133, 3178158, 3178360, 3178373, 3178406, 3178463, 3178468, 3178488, 3178622, 3178627, 3178641, 3178650, 3178670, 3178702, 3178715, 3178727, 3178786, 3178907, 3178937, 3178948, 3178952, 3178960, 3179200, 3179269, 3179474, 3179637, 3179743, 3179785, 3179814, 3179834, 3179908, 3179922, 3179950, 3180107, 3180186, 3180189, 3180210, 3180308, 3180473, 3180557, 3180623, 3180663, 3180678, 3180685, 3180751, 3180809, 3180876, 3181052, 3181775, 3181959, 3182004, 3182014, 3182126, 3182135, 3182149, 3182375, 3182387, 3182490, 3182494, 3182499, 3182653, 3182658, 3182688, 3182706, 3182762, 3182877, 3182934, 3182947, 3182982, 3182985, 3182986, 3183007, 3183016, 3183279, 3183363, 3183368, 3183584, 3183730, 3183738, 3183751, 3183762, 3183763, 3183776, 3183785, 3183787, 3183789, 3183819, 3183829, 3183838, 3183852, 3183928, 3184007, 3184120, 3184138, 3184154, 3184248, 3184358, 3184500, 3184595, 3184766, 3184780, 3185004, 3185084, 3185085, 3185182, 3185186, 3185283, 3185289, 3185512, 3185532, 3185540, 3185581, 3185584, 3185588, 3185730, 3185739, 3185768, 3185790, 3185910, 3186003, 3186027, 3186035, 3186052, 3186134, 3186183, 3186187, 3186197, 3186226, 3186229, 3186281, 3186310, 3186313, 3186360, 3186366, 3186373, 3186390, 3186421, 3186440, 3186467, 3186478, 3186506, 3186576, 3186601, 3186607, 3186610, 3186712, 3186818, 3186978, 3186980, 3187039, 3187137, 3187146, 3187170, 3187186, 3187236, 3187247, 3187278, 3187288, 3187375, 3187452, 3187472, 3187480, 3187496, 3187537, 3187565, 3187592, 3187612, 3187712, 3187806, 3187817, 3187835, 3187903, 3188055, 3188108, 3188648, 3188664, 3188679, 3188693, 3188696, 3188747, 3188808, 3188947, 3188987, 3189026, 3189060, 3189066, 3189093, 3189161, 3189192, 3189196, 3189242, 3189317, 3189467, 3189470, 3189513, 3189580, 3189629, 3189665, 3189760, 3189776, 3189814, 3190072, 3190148, 3190307, 3190329, 3190373, 3190409, 3190453, 3190587, 3190634, 3190652, 3190681, 3190717, 3190746, 3190784, 3190790, 3190824, 3190923, 3190961, 3191027, 3191092, 3191149, 3191204, 3191398, 3191457, 3191466, 3191505, 3191541, 3191582, 3191592, 3191632, 3191682, 3191688, 3191887, 3192026, 3192071, 3192111, 3192116, 3192154, 3192743, 3192791, 3192793, 3192795, 3192796, 3192822, 3192835, 3192839, 3192870, 3192893, 3192941, 3193272, 3193279, 3193708, 3194340, 3194362)";
		
		//echo "\n\nConsulta:";
		//echo "\n".$query;
		//echo "\n\n";
		
		// se ejecuta la consulta
		$resultado = @mysql_query($query);
        	
		if ( !$resultado ) {
			echo "\nOcurrio un error al generar la consulta";
		}
		else {
			echo "\nPreparando envio de correos...";
            
            if ( mysql_num_rows($resultado) < 1 ) {
                // no hay correos por enviar
                echo "\n----------- No se pudo obtener los registros --------------";
                
            } else {
                echo "\nDescargando XMLs:";
                while ($row = @mysql_fetch_assoc($resultado)) {
                    echo "\nXML de ctrxid: ".$row["customer_trx_id"];
                    
                    $elXML = $row["xml"];
                    
                    // se sustituye el regimen por el correcto
                    $elXML_correcto = str_replace ( "Adquisicion de Bienes" , "Personas Morales con Fines No Lucrativos" , $elXML);
                    
                    // el xml en utf8
                    $elXML_correcto = mb_convert_encoding($elXML_correcto, 'UTF-8', 'OLD-ENCODING');
                    
                    // se escribe el archivo
                    $filename = $row["customer_trx_id"].".xml";
                    $archivo_xml = fopen($filename, "w");
                    // se escribe el xml
                    fwrite($archivo_xml, $elXML_correcto);
                    fclose($archivo_xml);
                    echo "\n... ok";
                    
                }
                
            }
            echo "\nFinalizado";
		}
	    
		// se cierra la conexion
		@mysql_close();
	}
}


 ?>